
dist: trusty
# Always explicitly set sudo.  Otherwise travis' defaults may vary
# based on when the repository testing was enabled.
sudo: required

# Disable automagic
language: c
install: true

aliases:
  - &pg-ver 9.4


jobs:
  include:

    # === unit tests
    - stage: run pdb tests
      env: PDB_TEST=unit/openjdk8
      addons:
        postgresql: *pg-ver
      services: postgresql
      script: >-
        jdk_switcher use openjdk8
        && ext/bin/install-puppetserver
        && ext/travisci/run-clj-tests --unit

    - stage: run pdb tests
      env: PDB_TEST=unit/openjdk7
      addons:
        postgresql: *pg-ver
      services: postgresql
      script: >-
        jdk_switcher use openjdk7
        && ext/bin/install-puppetserver
        && ext/travisci/run-clj-tests --unit

    - stage: run pdb tests
      env: PDB_TEST=unit/oraclejdk8
      addons:
        postgresql: *pg-ver
      services: postgresql
      script: >-
        jdk_switcher use oraclejdk8
        && ext/bin/install-puppetserver
        && ext/travisci/run-clj-tests --unit

    - stage: run pdb tests
      env: PDB_TEST=unit/oraclejdk7
      addons:
        postgresql: *pg-ver
      services: postgresql
      script: >-
        jdk_switcher use oraclejdk7
        && ext/bin/install-puppetserver
        && ext/travisci/run-clj-tests --unit


    # === integration tests
    - stage: run pdb tests
      env: PDB_TEST=int/openjdk7/pup-4.8.0/srv-2.7.2
      addons:
        postgresql: *pg-ver
      services: postgresql
      script: >-
        jdk_switcher use openjdk7
        && ext/bin/install-puppetserver 2.7.2
        && PUPPET_VERSION=4.8.0 ext/travisci/run-clj-tests --integration

    - stage: run pdb tests
      env: PDB_TEST=int/openjdk8/pup-4.8.0/srv-2.7.2
      addons:
        postgresql: *pg-ver
      services: postgresql
      script: >-
        jdk_switcher use openjdk8
        && ext/bin/install-puppetserver 2.7.2
        && PUPPET_VERSION=4.8.0 ext/travisci/run-clj-tests --integration

    - stage: run pdb tests
      env: PDB_TEST=int/openjdk8/pup-latest/srv-2.7.2
      addons:
        postgresql: *pg-ver
      services: postgresql
      script: >-
        jdk_switcher use openjdk8
        && ext/bin/install-puppetserver 2.7.2
        && PUPPET_VERSION=latest ext/travisci/run-clj-tests --integration

    - stage: run pdb tests
      env: PDB_TEST=int/oraclejdk8/pup-4.8.0/srv-2.7.2
      addons:
        postgresql: *pg-ver
      services: postgresql
      script: >-
        jdk_switcher use oraclejdk8
        && ext/bin/install-puppetserver 2.7.2
        && PUPPET_VERSION=4.8.0 ext/travisci/run-clj-tests --integration

    - stage: run pdb tests
      env: PDB_TEST=int/oraclejdk8/pup-latest/srv-2.7.2
      addons:
        postgresql: *pg-ver
      services: postgresql
      script: >-
        jdk_switcher use oraclejdk8
        && ext/bin/install-puppetserver 2.7.2
        && PUPPET_VERSION=latest ext/travisci/run-clj-tests --integration


    # === spec tests
    - stage: run pdb tests
      env: PDB_TEST=spec/pup-4.0.0
      script: PUPPET_VERSION=4.0.0 ext/travisci/run-spec-tests

    - stage: run pdb tests
      env: PDB_TEST=spec/pup-latest
      script: PUPPET_VERSION=latest ext/travisci/run-spec-tests


notifications:
  email: false
  hipchat:
    rooms:
      secure: gZpfMrGsUEHKzHfDaq8S00Xd35gzwEzcAy5/VV7JOGcmXLyWlx7ojh/Ke4rJ1vOa59OlazyCt5o8uDhB0CcQnZ2Aa6ncoOyLpLLjO8/Ak8qsxPLgC4Ov/zuRA4oTvxqZtaR7Juwbeobp5lB1OSFb7o4G747tC2Ihd1Nhx717tdQ=
    template: >-
      %{commit_subject}
      / %{repository} %{branch} <a href="%{compare_url}">%{commit}</a> %{author}
      / <a href="%{build_url}">#%{build_number}</a> %{result} in %{elapsed_time}
    format: html

# Host addons handle buffer overflow in jdk 7 with travis' long
# hostnames:
#   https://github.com/travis-ci/travis-ci/issues/5227#issuecomment-165131913
#   http://mail.openjdk.java.net/pipermail/net-dev/2012-July/004603.html
#   http://bugs.java.com/bugdatabase/view_bug.do?bug_id=7089443
#   http://bugs.java.com/bugdatabase/view_bug.do?bug_id=7112670

addons:
  hosts:
    - pdbtest
  hostname: pdbtest
