language: clojure
lein: 2.7.1
dist: trusty

# Always explicitly set sudo.  Otherwise travis' defaults may vary
# based on when the repository testing was enabled.
sudo: required

matrix:
  include:
    # terminus unit tests (spec tests)
    - env: >
        NAME=rspec-puppet-4.0
        PDB_TEST_LANG=ruby
        PUPPET_VERSION=4.0.0

    - env: >
        NAME=rspec-puppet-latest
        PDB_TEST_LANG=ruby
        PUPPET_VERSION=latest

    # pdb unit tests
    - env: >
        NAME=unit-openjdk8
        PDB_TEST_LANG=clojure
        PDB_TEST_SELECTOR=:unit
      jdk: openjdk8

    - env: >
        NAME=unit-openjdk7
        PDB_TEST_LANG=clojure
        PDB_TEST_SELECTOR=:unit
      jdk: openjdk7

    - env: >
        NAME=unit-oracle8
        PDB_TEST_LANG=clojure
        PDB_TEST_SELECTOR=:unit
      jdk: oraclejdk8

    - env: >
        NAME=unit-oracle7
        PDB_TEST_LANG=clojure
        PDB_TEST_SELECTOR=:unit
      jdk: oraclejdk7

    # pdb + terminus + puppetserver + puppet integration tests
    - env: >
        NAME=integration-stable-openjdk7
        PDB_TEST_LANG=clojure
        PDB_TEST_SELECTOR=:integration
        PUPPET_VERSION=4.8.0
        PUPPETSERVER_VERSION=2.7.2
      jdk: openjdk7

    - env: >
        NAME=integration-stable-openjdk8
        PDB_TEST_LANG=clojure
        PDB_TEST_SELECTOR=:integration
        PUPPET_VERSION=4.8.0
        PUPPETSERVER_VERSION=2.7.2
      jdk: openjdk8

    - env: >
        NAME=integration-latest-puppet-openjdk8
        PDB_TEST_LANG=clojure
        PDB_TEST_SELECTOR=:integration
        PUPPET_VERSION=latest
        PUPPETSERVER_VERSION=2.7.2
      jdk: openjdk8

    - env: >
        NAME=integration-stable-oraclejdk8
        PDB_TEST_LANG=clojure
        PDB_TEST_SELECTOR=:integration
        PUPPET_VERSION=4.8.0
        PUPPETSERVER_VERSION=2.7.2
      jdk: oraclejdk8

    - env: >
        NAME=integration-latest-puppet-oraclejdk8
        PDB_TEST_LANG=clojure
        PDB_TEST_SELECTOR=:integration
        PUPPET_VERSION=latest
        PUPPETSERVER_VERSION=2.7.2
      jdk: oraclejdk8

before_install: ext/travisci/install_puppetserver.sh
script: ext/travisci/test.sh
on_success: ext/travisci/on-success

notifications:
  email: false
  hipchat:
    rooms:
      secure: gZpfMrGsUEHKzHfDaq8S00Xd35gzwEzcAy5/VV7JOGcmXLyWlx7ojh/Ke4rJ1vOa59OlazyCt5o8uDhB0CcQnZ2Aa6ncoOyLpLLjO8/Ak8qsxPLgC4Ov/zuRA4oTvxqZtaR7Juwbeobp5lB1OSFb7o4G747tC2Ihd1Nhx717tdQ=
    template:
      - '%{repository}#%{build_number} (%{branch} - %{commit} : %{author}): %{message} (<a href="%{build_url}">Details</a>/<a href="%{compare_url}">Change view</a>)'
    format: html

# Host addons handle buffer overflow in jdk 7 with travis' long
# hostnames:
#   https://github.com/travis-ci/travis-ci/issues/5227#issuecomment-165131913
#   http://mail.openjdk.java.net/pipermail/net-dev/2012-July/004603.html
#   http://bugs.java.com/bugdatabase/view_bug.do?bug_id=7089443
#   http://bugs.java.com/bugdatabase/view_bug.do?bug_id=7112670

addons:
  hosts:
    - pdbtest
  hostname: pdbtest
  postgresql: "9.4"

services: postgresql
